services:
  n8n:
    image: n8nio/n8n:latest
    container_name: learnfinance-n8n
    restart: unless-stopped
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}
      - GENERIC_TIMEZONE=${TZ:-Asia/Kolkata}
      - TZ=${TZ:-Asia/Kolkata}
    volumes:
      - n8n_data:/home/node/.n8n

  brain-api:
    build: ./brain_api
    container_name: learnfinance-brain-api
    restart: always
    ports:
      - "8000:8000"
    env_file:
      - ./brain_api/.env

  prefect-server:
    build: ./prefect
    container_name: learnfinance-prefect-server
    restart: always
    ports:
      - "4200:4200"
    command: ["uv", "run", "prefect", "server", "start", "--host", "0.0.0.0"]

  prefect-training:
    build: ./prefect
    container_name: learnfinance-prefect-training
    restart: always
    depends_on:
      - prefect-server
      - brain-api
    environment:
      - PREFECT_API_URL=http://prefect-server:4200/api
      - BRAIN_API_URL=http://brain-api:8000
    command: ["uv", "run", "python", "-m", "flows.weekly_training"]

  prefect-email:
    build: ./prefect
    container_name: learnfinance-prefect-email
    restart: always
    depends_on:
      - prefect-server
      - brain-api
    environment:
      - PREFECT_API_URL=http://prefect-server:4200/api
      - BRAIN_API_URL=http://brain-api:8000
    command: ["uv", "run", "python", "-m", "flows.weekly_forecast_email"]

volumes:
  n8n_data:

