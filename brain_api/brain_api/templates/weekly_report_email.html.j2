<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weekly Portfolio Analysis</title>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">

  <!-- Header -->
  <h1 style="color: #1f2937; margin-bottom: 8px;">Weekly Portfolio Analysis</h1>
  <div style="background-color: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
    <strong>Target Week:</strong> {{ target_week_start }} &rarr; {{ target_week_end }} &nbsp;|&nbsp;
    <strong>As-of Date:</strong> {{ as_of_date }}
  </div>

  <!-- Skipped Algorithms Warning (conditional) -->
  {% if skipped_algorithms %}
  <div style="margin-bottom: 24px; padding: 16px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
    <h3 style="color: #92400e; margin-top: 0;">Skipped Algorithms</h3>
    <p style="margin-bottom: 0;">The following algorithms were skipped due to open orders: <strong>{{ skipped_algorithms | join(", ") }}</strong></p>
    <p style="margin-top: 8px; font-size: 12px; color: #78716c;">Cancel the open orders in Alpaca to allow these algorithms to run on the next execution.</p>
  </div>
  {% endif %}

  <!-- Order Execution Summary Table -->
  <div style="margin-bottom: 24px; padding: 16px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
    <h3 style="color: #166534; margin-top: 0;">Order Execution Summary</h3>
    <table style="width: 100%; border-collapse: collapse;">
      <tr style="background: #dcfce7;">
        <th style="padding: 8px; text-align: left;">Account</th>
        <th style="padding: 8px; text-align: center;">Submitted</th>
        <th style="padding: 8px; text-align: center;">Failed</th>
      </tr>
      <tr>
        <td style="padding: 8px;">PPO</td>
        <td style="padding: 8px; text-align: center;">{{ "Skipped" if order_results.ppo.skipped else order_results.ppo.orders_submitted }}</td>
        <td style="padding: 8px; text-align: center;">{{ "-" if order_results.ppo.skipped else order_results.ppo.orders_failed }}</td>
      </tr>
      <tr>
        <td style="padding: 8px;">SAC</td>
        <td style="padding: 8px; text-align: center;">{{ "Skipped" if order_results.sac.skipped else order_results.sac.orders_submitted }}</td>
        <td style="padding: 8px; text-align: center;">{{ "-" if order_results.sac.skipped else order_results.sac.orders_failed }}</td>
      </tr>
      <tr>
        <td style="padding: 8px;">HRP</td>
        <td style="padding: 8px; text-align: center;">{{ "Skipped" if order_results.hrp.skipped else order_results.hrp.orders_submitted }}</td>
        <td style="padding: 8px; text-align: center;">{{ "-" if order_results.hrp.skipped else order_results.hrp.orders_failed }}</td>
      </tr>
    </table>
  </div>

  <!-- AI Analysis Section -->
  <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
    <h2 style="margin-top: 0; margin-bottom: 16px;">AI Analysis Summary</h2>
    
    {% if summary.para_1_overall_summary %}
    <div style="margin-bottom: 16px;">
      <h4 style="margin: 0 0 8px 0; opacity: 0.9;">1. Overall Market Summary</h4>
      <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ summary.para_1_overall_summary }}</p>
    </div>
    {% endif %}
    
    {% if summary.para_2_sac %}
    <div style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
      <h4 style="margin: 0 0 8px 0;">2. SAC Analysis</h4>
      <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ summary.para_2_sac }}</p>
    </div>
    {% endif %}
    
    {% if summary.para_3_ppo %}
    <div style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px;">
      <h4 style="margin: 0 0 8px 0;">3. PPO Analysis</h4>
      <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ summary.para_3_ppo }}</p>
    </div>
    {% endif %}
    
    {% if summary.para_4_hrp_summary %}
    <div style="margin-bottom: 16px;">
      <h4 style="margin: 0 0 8px 0; opacity: 0.9;">4. HRP Allocation Summary</h4>
      <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ summary.para_4_hrp_summary }}</p>
    </div>
    {% endif %}
    
    {% if summary.para_5_patchtst_forecast %}
    <div style="margin-bottom: 16px;">
      <h4 style="margin: 0 0 8px 0; opacity: 0.9;">5. PatchTST Forecast</h4>
      <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ summary.para_5_patchtst_forecast }}</p>
    </div>
    {% endif %}
    
    {% if summary.para_6_lstm_forecast %}
    <div style="margin-bottom: 16px;">
      <h4 style="margin: 0 0 8px 0; opacity: 0.9;">6. LSTM Forecast</h4>
      <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ summary.para_6_lstm_forecast }}</p>
    </div>
    {% endif %}
    
    {% if summary.para_7_news_sentiment %}
    <div style="margin-bottom: 16px;">
      <h4 style="margin: 0 0 8px 0; opacity: 0.9;">7. News Sentiment</h4>
      <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ summary.para_7_news_sentiment }}</p>
    </div>
    {% endif %}
    
    {% if summary.para_8_fundamentals %}
    <div>
      <h4 style="margin: 0 0 8px 0; opacity: 0.9;">8. Fundamentals</h4>
      <p style="font-size: 14px; line-height: 1.6; margin: 0;">{{ summary.para_8_fundamentals }}</p>
    </div>
    {% endif %}
  </div>

  <!-- RL Allocators Side-by-Side (SAC vs PPO) -->
  <div style="margin-bottom: 24px;">
    <h3 style="color: #374151; border-bottom: 2px solid #8b5cf6; padding-bottom: 8px;">RL Allocations (SAC vs PPO)</h3>
    <p style="color: #6b7280; font-size: 14px;">SAC turnover: {{ "%.1f" | format(sac.turnover * 100) }}% | PPO turnover: {{ "%.1f" | format(ppo.turnover * 100) }}%</p>
    <div style="display: flex; gap: 20px; margin-top: 12px;">
      <!-- SAC Column -->
      <div style="flex: 1;">
        <h4 style="margin: 0 0 8px 0; color: #6b7280; font-size: 13px;">SAC (Off-Policy RL) - v{{ sac.model_version }}</h4>
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="background-color: #fef2f2;">
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #ef4444; width: 30px;">#</th>
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #ef4444;">Symbol</th>
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #ef4444;">Weight</th>
            </tr>
          </thead>
          <tbody>
            {% for sym, wt in sac.target_weights.items() | sort(attribute='1', reverse=true) %}{% if loop.index <= 15 and sym != 'CASH' and wt > 0 %}
            <tr>
              <td style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb;">{{ loop.index }}</td>
              <td style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">{{ sym }}</td>
              <td style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <div style="width: {{ (wt * 300) | int }}px; height: 12px; background: linear-gradient(90deg, #ef4444, #f87171); border-radius: 3px;"></div>
                  <span>{{ "%.1f" | format(wt * 100) }}%</span>
                </div>
              </td>
            </tr>
            {% endif %}{% endfor %}
          </tbody>
        </table>
      </div>
      <!-- PPO Column -->
      <div style="flex: 1;">
        <h4 style="margin: 0 0 8px 0; color: #6b7280; font-size: 13px;">PPO (On-Policy RL) - v{{ ppo.model_version }}</h4>
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="background-color: #fffbeb;">
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #f59e0b; width: 30px;">#</th>
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #f59e0b;">Symbol</th>
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #f59e0b;">Weight</th>
            </tr>
          </thead>
          <tbody>
            {% for sym, wt in ppo.target_weights.items() | sort(attribute='1', reverse=true) %}{% if loop.index <= 15 and sym != 'CASH' and wt > 0 %}
            <tr>
              <td style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb;">{{ loop.index }}</td>
              <td style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">{{ sym }}</td>
              <td style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <div style="width: {{ (wt * 300) | int }}px; height: 12px; background: linear-gradient(90deg, #f59e0b, #fbbf24); border-radius: 3px;"></div>
                  <span>{{ "%.1f" | format(wt * 100) }}%</span>
                </div>
              </td>
            </tr>
            {% endif %}{% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- HRP Allocation -->
  <div style="margin-bottom: 24px;">
    <h3 style="color: #374151; border-bottom: 2px solid #10b981; padding-bottom: 8px;">HRP Allocation (Risk-Balanced Baseline)</h3>
    <p style="color: #6b7280; font-size: 14px;">Symbols allocated: {{ hrp.symbols_used }} | Based on 1-year covariance structure</p>
    <table style="width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 12px;">
      <thead>
        <tr style="background-color: #f0fdf4;">
          <th style="padding: 10px 8px; text-align: left; border-bottom: 2px solid #10b981; width: 40px;">#</th>
          <th style="padding: 10px 8px; text-align: left; border-bottom: 2px solid #10b981;">Symbol</th>
          <th style="padding: 10px 8px; text-align: left; border-bottom: 2px solid #10b981;">Weight</th>
        </tr>
      </thead>
      <tbody>
        {% for sym, wt in hrp.percentage_weights.items() | sort(attribute='1', reverse=true) %}{% if loop.index <= 15 and wt > 0 %}
        <tr>
          <td style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb;">{{ loop.index }}</td>
          <td style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">{{ sym }}</td>
          <td style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: {{ (wt * 3) | int }}px; height: 12px; background: linear-gradient(90deg, #10b981, #34d399); border-radius: 3px;"></div>
              <span>{{ "%.1f" | format(wt) }}%</span>
            </div>
          </td>
        </tr>
        {% endif %}{% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Forecasters Side-by-Side (LSTM vs PatchTST) -->
  <div style="margin-bottom: 24px;">
    <h3 style="color: #374151; border-bottom: 2px solid #3b82f6; padding-bottom: 8px;">Price Forecasts (Weekly Return Predictions)</h3>
    <p style="color: #6b7280; font-size: 14px;">Target: {{ lstm.target_week_start }} &rarr; {{ lstm.target_week_end }} | LSTM: {{ lstm.model_version }} | PatchTST: {{ patchtst.model_version }}</p>
    <div style="display: flex; gap: 20px; margin-top: 12px;">
      <!-- LSTM Column -->
      <div style="flex: 1;">
        <h4 style="margin: 0 0 8px 0; color: #6b7280; font-size: 13px;">LSTM (Pure Price)</h4>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #eff6ff;">
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #3b82f6; width: 30px; font-size: 12px;">#</th>
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #3b82f6; font-size: 12px;">Symbol</th>
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #3b82f6; font-size: 12px;">Predicted</th>
            </tr>
          </thead>
          <tbody>
            {% for p in lstm.predictions[:15] %}{% if p.has_enough_history %}
            <tr>
              <td style="padding: 5px 6px; border-bottom: 1px solid #e5e7eb; font-size: 12px;">{{ loop.index }}</td>
              <td style="padding: 5px 6px; border-bottom: 1px solid #e5e7eb; font-weight: bold; font-size: 12px;">{{ p.symbol }}</td>
              <td style="padding: 5px 6px; border-bottom: 1px solid #e5e7eb; font-weight: bold; font-size: 12px; color: {{ '#22c55e' if p.direction == 'UP' else '#ef4444' if p.direction == 'DOWN' else '#6b7280' }};">
                {{ '&uarr;' if p.direction == 'UP' else '&darr;' if p.direction == 'DOWN' else '&rarr;' }} {{ "%.2f" | format(p.predicted_weekly_return_pct) }}%
              </td>
            </tr>
            {% endif %}{% endfor %}
          </tbody>
        </table>
      </div>
      <!-- PatchTST Column -->
      <div style="flex: 1;">
        <h4 style="margin: 0 0 8px 0; color: #6b7280; font-size: 13px;">PatchTST (Multi-Signal)</h4>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #eff6ff;">
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #3b82f6; width: 30px; font-size: 12px;">#</th>
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #3b82f6; font-size: 12px;">Symbol</th>
              <th style="padding: 8px 6px; text-align: left; border-bottom: 2px solid #3b82f6; font-size: 12px;">Predicted</th>
            </tr>
          </thead>
          <tbody>
            {% for p in patchtst.predictions[:15] %}{% if p.has_enough_history %}
            <tr>
              <td style="padding: 5px 6px; border-bottom: 1px solid #e5e7eb; font-size: 12px;">{{ loop.index }}</td>
              <td style="padding: 5px 6px; border-bottom: 1px solid #e5e7eb; font-weight: bold; font-size: 12px;">{{ p.symbol }}</td>
              <td style="padding: 5px 6px; border-bottom: 1px solid #e5e7eb; font-weight: bold; font-size: 12px; color: {{ '#22c55e' if p.direction == 'UP' else '#ef4444' if p.direction == 'DOWN' else '#6b7280' }};">
                {{ '&uarr;' if p.direction == 'UP' else '&darr;' if p.direction == 'DOWN' else '&rarr;' }} {{ "%.2f" | format(p.predicted_weekly_return_pct) }}%
              </td>
            </tr>
            {% endif %}{% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div style="margin-top: 32px; padding-top: 16px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">
    <em>Generated by LearnFinance-2025 | SAC + PPO + HRP + LSTM + PatchTST + FinBERT + Fundamentals | Not financial advice</em><br/>
    Run ID: paper:{{ as_of_date }}
  </div>

</body>
</html>
