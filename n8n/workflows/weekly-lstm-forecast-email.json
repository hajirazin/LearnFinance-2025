{
  "name": "Weekly Forecast + News Sentiment Email",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "triggerAtDay": [1],
              "triggerAtHour": 18,
              "triggerAtMinute": 0
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Weekly Trigger (Mon 18:00 IST)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [180, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://host.docker.internal:8000/universe/halal",
        "options": {
          "timeout": 60000
        }
      },
      "id": "http-halal-universe",
      "name": "GET Halal Universe",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [400, 300]
    },
    {
      "parameters": {
        "jsCode": "// Extract top N symbols from halal universe\nconst N = 20;\n\nconst stocks = $input.first().json.stocks || [];\nconst symbols = stocks.slice(0, N).map(s => s.symbol);\n\n// Pass the run date (today in IST) for the inference request\nconst now = new Date();\nconst istOffset = 5.5 * 60 * 60 * 1000; // IST is UTC+5:30\nconst istDate = new Date(now.getTime() + istOffset);\nconst asOfDate = istDate.toISOString().split('T')[0];\nconst runId = `paper:${asOfDate}`;\n\nreturn {\n  json: {\n    symbols: symbols,\n    as_of_date: asOfDate,\n    run_id: runId,\n    stock_count: symbols.length\n  }\n};"
      },
      "id": "code-pick-symbols",
      "name": "Pick Top 20 Symbols",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [620, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:8000/inference/lstm",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ symbols: $json.symbols, as_of_date: $json.as_of_date }) }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "http-lstm-inference",
      "name": "POST LSTM Inference",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [840, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:8000/signals/news",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ symbols: $json.symbols, as_of_date: $json.as_of_date, run_id: $json.run_id, max_articles_per_symbol: 10, return_top_k: 3 }) }}",
        "options": {
          "timeout": 180000
        }
      },
      "id": "http-news-sentiment",
      "name": "POST News Sentiment",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [840, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:8000/allocation/hrp",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ as_of_date: $json.as_of_date }) }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "http-hrp-allocation",
      "name": "POST HRP Allocation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [840, 500]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "merge-lstm-news",
      "name": "Merge LSTM + News",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1060, 200]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "merge-all",
      "name": "Merge All + HRP",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1280, 350]
    },
    {
      "parameters": {
        "jsCode": "// Combine LSTM, News Sentiment, and HRP data for OpenAI prompt\nconst inputs = $input.all();\n\n// With chained combineByPosition, all data is merged into the first item\nconst mergedData = inputs[0]?.json || {};\n\n// Extract LSTM data (has 'predictions' array)\nconst predictions = mergedData.predictions || [];\n\n// Extract News data (has 'per_symbol' array)\nconst newsSentiments = mergedData.per_symbol || [];\n\n// Extract HRP data (has 'percentage_weights' object)\nconst hrpWeights = mergedData.percentage_weights || {};\nconst hrpSymbolsUsed = mergedData.symbols_used || 0;\nconst hrpSymbolsExcluded = mergedData.symbols_excluded || [];\n\n// Create a lookup map for news sentiment by symbol\nconst newsMap = {};\nfor (const ns of newsSentiments) {\n  newsMap[ns.symbol] = ns;\n}\n\n// Build combined data for each symbol\nconst combined = predictions.map(p => {\n  const news = newsMap[p.symbol] || null;\n  const hrpWeight = hrpWeights[p.symbol] || null;\n  return {\n    symbol: p.symbol,\n    predicted_return_pct: p.predicted_weekly_return_pct,\n    direction: p.direction,\n    has_enough_history: p.has_enough_history,\n    sentiment_score: news ? news.sentiment_score : null,\n    insufficient_news: news ? news.insufficient_news : true,\n    hrp_weight_pct: hrpWeight,\n    top_articles: news ? news.top_k_articles : []\n  };\n});\n\n// Build HRP summary for prompt\nconst hrpTop5 = Object.entries(hrpWeights)\n  .slice(0, 5)\n  .map(([sym, wt]) => `${sym}: ${wt.toFixed(1)}%`)\n  .join(', ');\n\n// Build prompt for OpenAI\nconst symbolSummaries = combined\n  .filter(c => c.has_enough_history)\n  .slice(0, 10) // Top 10 for brevity\n  .map(c => {\n    const articles = c.top_articles.slice(0, 2).map(a => `\"${a.title}\"`).join(', ');\n    const hrpStr = c.hrp_weight_pct ? `HRP=${c.hrp_weight_pct.toFixed(1)}%` : 'HRP=N/A';\n    return `- ${c.symbol}: LSTM ${c.direction} (${c.predicted_return_pct?.toFixed(2) || 'N/A'}%), sentiment=${c.sentiment_score?.toFixed(2) || 'N/A'}, ${hrpStr}. Headlines: ${articles || 'none'}`;\n  }).join('\\n');\n\nconst prompt = `You are a financial analyst assistant. Based on the following data, provide a brief structured analysis in JSON format.\n\nData sources:\n1. LSTM: Weekly return predictions (direction and %)\n2. News Sentiment: FinBERT sentiment scores (-1 to +1)\n3. HRP (Hierarchical Risk Parity): Risk-based portfolio allocation\n\nTop HRP allocations: ${hrpTop5}\n\nPer-symbol data:\n${symbolSummaries}\n\nRespond with valid JSON only (no markdown), containing:\n{\n  \"market_outlook\": \"<1-2 sentence overall assessment combining LSTM predictions, sentiment, and HRP risk allocation>\",\n  \"top_opportunities\": [\"<symbol1>\", \"<symbol2>\", \"<symbol3>\"],\n  \"top_opportunities_reasoning\": \"<brief explanation why these are opportunities>\",\n  \"key_risks\": [\"<brief risk 1>\", \"<brief risk 2>\"],\n  \"portfolio_insight\": \"<1 sentence about HRP allocation - which sectors/stocks get higher weight and why>\",\n  \"notable_news_themes\": [\"<theme1>\", \"<theme2>\"]\n}`;\n\nreturn {\n  json: {\n    lstm: { predictions: predictions, model_version: mergedData.model_version, target_week_start: mergedData.target_week_start, target_week_end: mergedData.target_week_end },\n    news: { per_symbol: newsSentiments, run_id: mergedData.run_id, from_cache: mergedData.from_cache },\n    hrp: { percentage_weights: hrpWeights, symbols_used: hrpSymbolsUsed, symbols_excluded: hrpSymbolsExcluded, as_of_date: mergedData.as_of_date },\n    combined: combined,\n    openai_prompt: prompt\n  }\n};"
      },
      "id": "code-prepare-openai",
      "name": "Prepare OpenAI Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 350]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.openai_prompt }}"
            }
          ]
        },
        "options": {
          "temperature": 0.3,
          "maxTokens": 600
        }
      },
      "id": "openai-summary",
      "name": "OpenAI Summary",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [1720, 350],
      "credentials": {
        "openAiApi": {
          "id": "",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format the final email: AI Summary -> HRP -> LSTM\nconst input = $input.first().json;\nconst prevData = $('Prepare OpenAI Prompt').first().json;\n\nconst lstmData = prevData.lstm || {};\nconst newsData = prevData.news || {};\nconst hrpData = prevData.hrp || {};\nconst combined = prevData.combined || [];\n\n// Parse OpenAI response\nlet aiSummary = {};\ntry {\n  const content = input.message?.content || input.choices?.[0]?.message?.content || '{}';\n  aiSummary = JSON.parse(content);\n} catch (e) {\n  aiSummary = { market_outlook: 'Unable to generate AI summary', top_opportunities: [], key_risks: [], notable_news_themes: [], portfolio_insight: '' };\n}\n\nconst predictions = lstmData.predictions || [];\nconst modelVersion = lstmData.model_version || 'unknown';\nconst targetWeekStart = lstmData.target_week_start || 'N/A';\nconst targetWeekEnd = lstmData.target_week_end || 'N/A';\nconst asOfDate = hrpData.as_of_date || lstmData.as_of_date || 'N/A';\n\n// HRP data\nconst hrpWeights = hrpData.percentage_weights || {};\nconst hrpSymbolsUsed = hrpData.symbols_used || 0;\n\n// Separate valid and insufficient-history predictions\nconst valid = predictions.filter(p => p.has_enough_history);\nconst insufficient = predictions.filter(p => !p.has_enough_history);\n\n// Create news sentiment lookup\nconst newsMap = {};\nfor (const ns of (newsData.per_symbol || [])) {\n  newsMap[ns.symbol] = ns;\n}\n\n// ============ AI SUMMARY SECTION ============\nconst topOpps = (aiSummary.top_opportunities || []).join(', ') || 'None identified';\nconst topOppsReason = aiSummary.top_opportunities_reasoning || '';\nconst keyRisks = (aiSummary.key_risks || []).map(r => `<li>${r}</li>`).join('') || '<li>None identified</li>';\nconst themes = (aiSummary.notable_news_themes || []).join(', ') || 'None identified';\nconst portfolioInsight = aiSummary.portfolio_insight || 'N/A';\n\nconst aiSection = `\n  <div style=\"margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;\">\n    <h2 style=\"margin-top: 0; margin-bottom: 16px;\">ü§ñ AI Analysis Summary</h2>\n    <p style=\"font-size: 16px; line-height: 1.6;\"><strong>Market Outlook:</strong> ${aiSummary.market_outlook || 'N/A'}</p>\n    <p><strong>Top Opportunities:</strong> ${topOpps}</p>\n    ${topOppsReason ? `<p style=\"font-size: 14px; opacity: 0.9;\"><em>${topOppsReason}</em></p>` : ''}\n    <p><strong>Portfolio Insight:</strong> ${portfolioInsight}</p>\n    <p><strong>Key Risks:</strong></p>\n    <ul style=\"margin: 4px 0;\">${keyRisks}</ul>\n    <p><strong>News Themes:</strong> ${themes}</p>\n  </div>\n`;\n\n// ============ HRP SECTION ============\nlet hrpTableRows = '';\nlet rank = 1;\nfor (const [symbol, weight] of Object.entries(hrpWeights)) {\n  const weightStr = weight.toFixed(2) + '%';\n  const barWidth = Math.min(weight * 3, 100); // Scale for visual bar\n  hrpTableRows += `<tr>\n    <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb;\">${rank}</td>\n    <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;\">${symbol}</td>\n    <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb;\">\n      <div style=\"display: flex; align-items: center; gap: 8px;\">\n        <div style=\"width: ${barWidth}px; height: 16px; background: linear-gradient(90deg, #10b981, #34d399); border-radius: 4px;\"></div>\n        <span style=\"font-weight: bold;\">${weightStr}</span>\n      </div>\n    </td>\n  </tr>`;\n  rank++;\n}\n\nconst hrpSection = `\n  <div style=\"margin-bottom: 24px;\">\n    <h3 style=\"color: #374151; border-bottom: 2px solid #10b981; padding-bottom: 8px;\">üìä HRP Portfolio Allocation (Risk-Balanced)</h3>\n    <p style=\"color: #6b7280; font-size: 14px;\">Symbols allocated: ${hrpSymbolsUsed} | Based on 1-year covariance structure</p>\n    <table style=\"width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 12px;\">\n      <thead>\n        <tr style=\"background-color: #f0fdf4;\">\n          <th style=\"padding: 12px 8px; text-align: left; border-bottom: 2px solid #10b981; width: 50px;\">#</th>\n          <th style=\"padding: 12px 8px; text-align: left; border-bottom: 2px solid #10b981;\">Symbol</th>\n          <th style=\"padding: 12px 8px; text-align: left; border-bottom: 2px solid #10b981;\">Weight</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${hrpTableRows}\n      </tbody>\n    </table>\n  </div>\n`;\n\n// ============ LSTM SECTION ============\nlet lstmTableRows = '';\nfor (let i = 0; i < valid.length; i++) {\n  const p = valid[i];\n  const ns = newsMap[p.symbol];\n  \n  const ret = p.predicted_weekly_return_pct;\n  const retStr = ret !== null ? (ret >= 0 ? '+' : '') + ret.toFixed(2) + '%' : 'N/A';\n  const direction = p.direction;\n  const color = direction === 'UP' ? '#22c55e' : direction === 'DOWN' ? '#ef4444' : '#6b7280';\n  const arrow = direction === 'UP' ? '‚Üë' : direction === 'DOWN' ? '‚Üì' : '‚Üí';\n  \n  // Sentiment\n  const sentScore = ns ? ns.sentiment_score : null;\n  let sentStr = 'N/A';\n  let sentColor = '#6b7280';\n  if (sentScore !== null) {\n    sentStr = sentScore >= 0 ? '+' + sentScore.toFixed(2) : sentScore.toFixed(2);\n    sentColor = sentScore > 0.1 ? '#22c55e' : sentScore < -0.1 ? '#ef4444' : '#6b7280';\n  }\n  \n  lstmTableRows += `<tr>\n    <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb;\">${i + 1}</td>\n    <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;\">${p.symbol}</td>\n    <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; color: ${color}; font-weight: bold;\">${arrow} ${retStr}</td>\n    <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; color: ${color};\">${direction}</td>\n    <td style=\"padding: 8px; border-bottom: 1px solid #e5e7eb; color: ${sentColor};\">${sentStr}</td>\n  </tr>`;\n}\n\n// Build insufficient history section if any\nlet insufficientSection = '';\nif (insufficient.length > 0) {\n  const insufficientSymbols = insufficient.map(p => p.symbol).join(', ');\n  insufficientSection = `\n    <div style=\"margin-top: 16px; padding: 12px; background-color: #fef3c7; border-radius: 8px; font-size: 14px;\">\n      <strong>‚ö†Ô∏è Insufficient History (${insufficient.length}):</strong> ${insufficientSymbols}\n    </div>\n  `;\n}\n\nconst lstmSection = `\n  <div style=\"margin-bottom: 24px;\">\n    <h3 style=\"color: #374151; border-bottom: 2px solid #3b82f6; padding-bottom: 8px;\">üìà LSTM Return Predictions (Sorted: Highest ‚Üí Lowest)</h3>\n    <p style=\"color: #6b7280; font-size: 14px;\">Model: ${modelVersion} | Target: ${targetWeekStart} ‚Üí ${targetWeekEnd}</p>\n    <table style=\"width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 12px;\">\n      <thead>\n        <tr style=\"background-color: #eff6ff;\">\n          <th style=\"padding: 12px 8px; text-align: left; border-bottom: 2px solid #3b82f6;\">#</th>\n          <th style=\"padding: 12px 8px; text-align: left; border-bottom: 2px solid #3b82f6;\">Symbol</th>\n          <th style=\"padding: 12px 8px; text-align: left; border-bottom: 2px solid #3b82f6;\">Predicted Return</th>\n          <th style=\"padding: 12px 8px; text-align: left; border-bottom: 2px solid #3b82f6;\">Direction</th>\n          <th style=\"padding: 12px 8px; text-align: left; border-bottom: 2px solid #3b82f6;\">News Sentiment</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${lstmTableRows}\n      </tbody>\n    </table>\n    ${insufficientSection}\n  </div>\n`;\n\n// ============ FULL EMAIL ============\nconst emailBody = `\n<div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;\">\n  <h1 style=\"color: #1f2937; margin-bottom: 8px;\">Weekly Portfolio Analysis</h1>\n  \n  <div style=\"background-color: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 24px;\">\n    <strong>Target Week:</strong> ${targetWeekStart} ‚Üí ${targetWeekEnd} &nbsp;|&nbsp;\n    <strong>As-of Date:</strong> ${asOfDate} &nbsp;|&nbsp;\n    <strong>Stocks:</strong> ${valid.length} analyzed\n  </div>\n  \n  ${aiSection}\n  \n  ${hrpSection}\n  \n  ${lstmSection}\n  \n  <div style=\"margin-top: 32px; padding-top: 16px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;\">\n    <em>Generated by LearnFinance-2025 | LSTM + FinBERT + HRP | Not financial advice</em><br/>\n    Run ID: paper:${asOfDate}\n  </div>\n</div>\n`;\n\nreturn {\n  json: {\n    emailSubject: `Weekly Portfolio Analysis (${targetWeekStart} ‚Üí ${targetWeekEnd})`,\n    emailBody: emailBody,\n    targetWeekStart: targetWeekStart,\n    targetWeekEnd: targetWeekEnd,\n    validCount: valid.length,\n    insufficientCount: insufficient.length,\n    hrpSymbolsUsed: hrpSymbolsUsed,\n    aiSummary: aiSummary\n  }\n};"
      },
      "id": "code-format-email",
      "name": "Format Email Body",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1940, 350]
    },
    {
      "parameters": {
        "sendTo": "hajirazin@gmail.com",
        "subject": "={{ $json.emailSubject }}",
        "message": "={{ $json.emailBody }}",
        "options": {
          "appendAttribution": false
        }
      },
      "id": "gmail-send",
      "name": "Gmail Send Forecast",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [2160, 350],
      "credentials": {
        "gmailOAuth2": {
          "id": "",
          "name": "Gmail OAuth2"
        }
      }
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger (for testing)",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [180, 480]
    }
  ],
  "connections": {
    "Weekly Trigger (Mon 18:00 IST)": {
      "main": [
        [
          {
            "node": "GET Halal Universe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Halal Universe": {
      "main": [
        [
          {
            "node": "Pick Top 20 Symbols",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pick Top 20 Symbols": {
      "main": [
        [
          {
            "node": "POST LSTM Inference",
            "type": "main",
            "index": 0
          },
          {
            "node": "POST News Sentiment",
            "type": "main",
            "index": 0
          },
          {
            "node": "POST HRP Allocation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST LSTM Inference": {
      "main": [
        [
          {
            "node": "Merge LSTM + News",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST News Sentiment": {
      "main": [
        [
          {
            "node": "Merge LSTM + News",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge LSTM + News": {
      "main": [
        [
          {
            "node": "Merge All + HRP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST HRP Allocation": {
      "main": [
        [
          {
            "node": "Merge All + HRP",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge All + HRP": {
      "main": [
        [
          {
            "node": "Prepare OpenAI Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare OpenAI Prompt": {
      "main": [
        [
          {
            "node": "OpenAI Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Summary": {
      "main": [
        [
          {
            "node": "Format Email Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Email Body": {
      "main": [
        [
          {
            "node": "Gmail Send Forecast",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger (for testing)": {
      "main": [
        [
          {
            "node": "GET Halal Universe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Kolkata"
  },
  "staticData": null,
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": false,
    "instanceId": "learnfinance-2025"
  }
}
